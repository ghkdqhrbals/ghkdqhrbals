---
layout: default
title: "실시간 채팅방 구현(21)<br/>(Postgresql 지표 관찰)"
parent: 실시간 채팅서버 프로젝트
nav_order: 21
---

기존에 Postgres의 통계를 일일이 찍어서 관찰했었는데요, AWS RDS를 사용하면 그래프화 하여 손쉽게 관찰할 수 있습니다.
그래서 AWS가 제공해주는 DB 매니지먼트 툴을 사용하고자 **auth-DB만 Local에서 AWS RDS(Postgres)로 이전**하였습니다.
> 또한 자동으로 백업 스냅샷까지 툴로 제공해주니, 정말 너무 편리했습니다ㅜㅜ... 진작에 AWS RDS 를 써볼껄 그랬네요.

# AWS RDS 그래프 지표 관찰

![img](../../../assets/img/rds/1.PNG)
![img](../../../assets/img/rds/2.PNG)
![img](../../../assets/img/rds/3.png)

* Splice 지표 설명
  * **LWLock:WALInsert** : Checkpointer 프로세스는 WAL 버퍼에 WAL 레코드를 저장합니다. 이 때 걸리는 Lock 입니다.
  * **LWLock:WALWrite** : WAL Writer 는 WAL 버퍼가 가득 찼을 때, WAL 버퍼를 WAL 파일에 옮깁니다. 이 떄 걸리는 Lock 입니다.
  > LWLock 은 SharedMemory 에 접근할 때 걸리는 Lock입니다. WAL은 변경기록입니다. tx_log입니다.
  * **IO:WALSync** : WAL 파일을 Archive 파일에 옮기는 과정입니다.
  * **Client:ClientWrite** : 클라이언트가 힘들 때 ClientWrite 이벤트가 트리거됩니다. 즉, DB 클러스터는 준비가 되어있지만, 클라이언트가 제 때 받지 못할 때 이 이벤트가 발생하게 됩니다.
    * 발생이유
      * PostgreSQL DB 클러스터와 클라이언트 간의 네트워크 처리량이 감소하면 이 이벤트가 발생할 수 있습니다.
      * 클라이언트에 대한 CPU 압력 및 네트워크 포화 상태시에도 이 이벤트가 발생할 수 있습니다

더 자세한 설명들은 [https://docs.aws.amazon.com/ko_kr/AmazonRDS/latest/AuroraUserGuide/AuroraPostgreSQL.Reference.Waitevents.html](https://docs.aws.amazon.com/ko_kr/AmazonRDS/latest/AuroraUserGuide/AuroraPostgreSQL.Reference.Waitevents.html)를 참고하시면 됩니다.


# Postgresql 상세 동작과정 및 아키텍처
* [https://blog.ex-em.com/1657](https://blog.ex-em.com/1657)

### WAL(Write-ahead logging) 이란?

> Part of the **data** that a DBMS works with **is stored in RAM** and gets written to disk (or other nonvolatile storage) asynchronously, i. e., writes are postponed for some time. The more infrequently this happens the less is the input/output and the faster the system operates.
>
> But what will happen in case of failure, for example, power outage or an error in the code of the DBMS or operating system? All the contents of RAM will be lost, and only data written to disk will survive (disks are not immune to certain failures either, and only a backup copy can help if data on disk are affected). In general, it is possible to organize input/output in such a way that data on disk are always consistent, but this is complicated and not that much efficient (to my knowledge, only Firebird chose this option).
>
> Usually, and specifically in PostgreSQL, data written to **disk** appear to be **inconsistent**, and when recovering after failure, special actions are required to restore data consistency. Write-ahead logging (WAL) is just a feature that makes it possible.

* reference
    [https://www.educba.com/postgresql-wal/](https://www.educba.com/postgresql-wal/)
    
    [https://postgrespro.com/blog/pgsql/5967951](https://postgrespro.com/blog/pgsql/5967951)

### 왜 WAL 사용할까?
buffer cache alleviates the difference between the time of access to RAM (nanoseconds) and disk storage (milliseconds).
