---
layout: default
title: 47. 서버성능 개선기록 - 🟢MTTFB p99 48%, TPS p99 121% 개선
parent: 📌 실시간 채팅서버 프로젝트
nav_order: 47
---

created at 2024-02-04
{: .label .label-yellow }

## Table of contents
{: .no_toc .text-delta }

1. TOC
{:toc}

   

## 테스트 환경
* Thread(virtual user) : 100
* URL : GET /api-chat/friends
* Duration : 1 min
* Test-Server
    * CPU : 8 virtual core
    * Memory : 32GB
    * OS : MacOS Big Sur
* Target-Server
    * Instance Type: `t3.medium` * 3
    * CPU : `2 virtual core` * 3 = 6 virtual core
    * Memory : 4GB * 3 = 12GB
    * OS : Amazon Linux 2 x86_64 HVM gp2

## RDB 캐싱으로 성능개선

친구목록을 조회하는 API 는 RDB 에서 데이터를 조회하는데, 이를 캐싱하여 성능을 개선하였습니다.

여러가지 캐싱 방법중 저는 읽기 전략에 Cache-Aside 를 선택하였습니다. RDB 조회 이전에 캐시에서 데이터를 조회하고, 캐시에 없을 경우 RDB 에서 조회하여 캐시에 저장하는 방식입니다. 쓰기 전략은 Write-Around 패턴을 적용하였습니다. 그냥 RDB 에 바로 써버리는 거죠.

Cache-Aside 쓴 이유는 아무래도 캐싱하고자 하는 데이터만 쉽게 분리할 수 있어서 사용했습니다. 읽기 전략 중 또 다른 전략인 Read Through 는 추가로 또 캐시와 RDB 를 동기화시켜줘야되서 힘들거든요.

> 캐시 읽기 전략! 두 가지가 있습니다.
> * Cache-Aside : RDB 조회 이전에 캐시에서 데이터를 조회하고, 캐시에 없을 경우 RDB 에서 조회하여 캐시에 저장하는 방식입니다.
> * Read-Through : RDB 조회를 캐시에 위임하여 캐시에 데이터가 없을 경우 RDB 에서 데이터를 조회하여 캐시에 저장하는 방식입니다.

Write-Around 를 선택한 이유는 쓰기 작업에 대한 캐시 부하가 없으므로, 쓰기 작업이 빈번하게 발생하지 않는 시나리오에 적합하기 때문입니다.

> 캐시 쓰기 전략은 Write-Through, Write-Around, Write-Back 세 가지가 있습니다.
>
> * Write-Back 전략은 데이터를 캐시에 모아두었다가 스케줄링 또는 특정 조건에 따라 RDB에 쓰는 방식입니다. 데이터가 캐시에 저장된 이후 즉시 RDB에 업데이트되지 않고, 일정 시간 동안 캐시에 남아 있을 수 있습니다.
>   * 장점: 쓰기 작업이 빈번하게 발생할 때 성능을 향상시킬 수 있으며, 일괄 처리로 쓰기 작업을 최적화할 수 있습니다.
>   * 단점: 쓰기 작업이 캐시에만 저장되므로 캐시와 RDB 사이에 데이터 불일치가 발생할 가능성이 있습니다. 또한 Write-Back 쓰기 전략은 데이터 손실 위험이 있을 수 있습니다.
> * Write-Through 전략은 데이터를 캐시에 저장한 후 즉시 RDB에도 저장하는 방식입니다. 데이터가 캐시에 저장되면 항상 RDB에도 업데이트되므로 항상 최신 데이터를 유지합니다.
>   * 장점: 데이터 일관성을 유지하며 캐시에 항상 최신 데이터가 유지됩니다.
>   * 단점: 쓰기 작업이 자주 발생하면 RDB에 대한 부하가 증가할 수 있으며, 불필요한 I/O 작업이 발생할 수 있습니다.
> * Write-Around 전략은 데이터를 바로 RDB에 쓰는 방식입니다. 데이터가 캐시를 거치지 않고 바로 RDB에 저장되므로 쓰기 작업에 대한 캐시 부하가 없습니다. 이후에 캐시를 따로 업데이트합니다.
>   * 장점: 쓰기 작업에 대한 캐시 부하가 없으므로, 쓰기 작업이 빈번하게 발생하지 않는 시나리오에 적합합니다. 데이터 일관성을 유지하며 쓰기 작업을 최적화합니다.
>   * 단점: 읽기 작업에서 최신 데이터를 얻을 때 RDB에서 데이터를 가져와야 하므로 읽기 작업에는 일시적인 지연이 발생할 수 있습니다.


Write-Around 적용 시 캐시는 RDB 에 맞춰서 업데이트 되야겠죠? 제 경우는 실시간으로 추가된 친구들이 업데이트 되어야 합니다. 그래서 데이터를 쓸 때 캐시를 삭제하도록 하였습니다. 그리고 이후 사용자가 해당 데이터를 다시 읽을 때 업데이트 되도록 설정했죠.

그래서 결과는요?!!

![img](../../../assets/caching/Untitled.png)
![img](../../../assets/caching/Untitled2.png)
![img](../../../assets/caching/Untitled3.png)

| Metric             | Before       | After        | Change     |
|--------------------|--------------|--------------|------------|
| Total Tests        | 12,356       | 16,788       | 36.00% 🟢  |
| Error Rate         | 0.00%(0)     | 0.00%(0)     | 0 ⚪        |
| TPS 평균 (Average)  | 228.81       | 310.89       | 35.87% 🟢  |
| TPS p50            | 240.50       | 307.50       | 27.84% 🟢  |
| TPS p95            | 162.40       | 282.85       | 74.20% 🟢  |
| TPS p99            | 107.09       | 237.47       | 121.77% 🟢 |
| TPS p99.9          | 90.36        | 223.55       | 147.24% 🟢 |
| MTTFB 평균 (Average)| 438.32 ms   | 324.82 ms   | -25.93% 🟢 |
| MTTFB p50          | 432.94 ms   | 323.11 ms   | -25.27% 🟢 |
| MTTFB p95          | 733.43 ms   | 380.09 ms   | -48.14% 🟢 |
| MTTFB p99          | 912.43 ms   | 471.73 ms   | -48.31% 🟢 |
| MTTFB p99.9        | 951.93 ms   | 496.67 ms   | -47.85% 🟢 |
| MTTFB 차이 평균 (Average Difference)| 65.06 ms | 24.31 ms | -62.68% 🟢 |
| MTTFB 평균적인 변동률 (Average Variability)| 13.73% | 7.67% | -44.11% 🟢 |

모든 지표에서 성능이 크게 향상되었습니다. 특히 상위 지표인 TPS p95, p99, TPS p99.9, MTTFB p95, MTTFB p99, MTTFB p99.9 의 경우 큰 폭으로 상승했습니다.
RDB 읽기쿼리에 대한 부담이 적어지면서 발생한 결과라고 볼 수 있겠죠?

이제 다음 개선해 볼 것은 채팅을 Redis 에 담아뒀다가 나중에 한꺼번에 업데이트 시키는 방식을 적용해보려고 합니다. Write-Back 방식이 되겠네용. 이 방식을 적용하면 채팅추가 API 성능이 매우 향상될 것으로 기대됩니다. 이에 대한 결과는 다음에 공유드리겠습니다. 😊
