---
layout: default
title: 배치 처리 성능 향상
date: 2024-10-12
parent: Server
nav_order: 19
---

created at 2024-10-12
{: .label .label-yellow }

## Table of contents
{: .no_toc .text-delta }

1. TOC
{:toc}

# 유저들의 등급을 매월 업데이트하는 배치 프로세스

해당 프로세스를 개발하면서 성능 향상 결과 내용잡동사니을 정리합니다.

* 100만명 유저 등급 업데이트에 소요되는 시간 변화
  1. 19m 13s : 커넥션풀 10개, 커널스레드, offset limit 조회
  2. 8m 15s : 커넥션풀 30개, 커널스레드, offset limit 조회
  3. 53s : 커넥션풀 30개, VirtualThread, id range 조회
* 바꾼 포인트 설명
  * b-tree 시작부터 offset 값 까지 전부 인덱스 스캔하는 과정이 필요한 offset limit 는 sliding window 방식 id range 조회로 변경.
  * step 실행 chunk size 를 100 -> 5 로 변경하면서 스레드를 더 많이 사용하도록 변경( + 그에 맞춰 CP 도 증가)
  * VirtualThread 를 사용하는 대신 기존 ThreadLocal 로 사용하던 Reader 내부 list 말고 override read() 메서드 내부에 stack 에만 저장하고 즉시 반환하도록 변경
  * 업데이트 쿼리 날리는 거 벌크처리
  * select 쿼리 날리는 거 필요칼럼만 가져오도록 변경
  * sliding window id range 조회 시, 만약 빈 리스트 반환하여도 최대 user.id(sequence) 값 도달하지 않았으면 window 반복 sliding
  > id 값이 건너뛸 경우가 있기 때문
